{% extends 'header.html' %}

{% block content %}

<html>
<head>
  <title> IT 490 - Library App</title>
</head>

<h1>Welcome to IT 490 Class</h1>
<h5><b><i>Note:</i></b> Please register a new user first.<br>
Then Login with the same credentials. You will get error if you enter wrong username or password.<br>
  You will also get error if you register a user that has the same username. <br>
  The Librarian Registration is different because it gives access to the main website. <br>
  The librarian can add and delete rooms and send messages as well.
</h5>
<div style="text-align: center">
<h1 class="form-heading">Login Form</h1>

<div class="login-form">
  <div class="main-div">
    <div class="panel">
      <h2>Login</h2>
      <p>Please enter your Username and Password</p>
    </div>
    <form id="login">

      <div class="form-group">

        <i class="fa fa-user"></i>
        <input type="text" class="form-control" id="name" placeholder="Username" required>

      </div>

      <div class="form-group">

        <input type="password" class="form-control" id="password" placeholder="Password" required>

      </div>
      
      <button type="submit" class="btn btn-primary" id="send">Login</button>

      <div class="forgot">
        <a href="/signup">I am a New User</a>
      </div>

    </form>
  </div>
</div>
</div>
</div>
</div>
<div id="result"></div>
</html>


<script type="text/javascript">
  $("document").ready(function () {
    $("#login").submit(function (e) {
      e.preventDefault();
      var username = $("#name").val();
      console.log(username);

      var password = $("#password").val();
      console.log(password);
      $.ajax({
        url: "http://127.0.0.1:5000/login",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ "username": username, "password": password }),
        success: function (data) {
          console.log(data);
          localStorage.setItem('token', data.token)
          console.log(localStorage.getItem('token'))
          if (parseJwt(data.token).admin == true) {
            window.location.href = "/librarian"
          }
          else {
            window.location.href = "/student_dash"
          }
        },
        error: function() {
            alert('Please check your Username and Password');
        }
        
      });
      
      
    });
  });
  function parseJwt(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
  };  
</script>
{% endblock %}